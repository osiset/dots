#!/bin/bash

# 1. Creates XFCE terminal colors
# 2. Modifies source of theme for Xresources
# 3. Reloads resources
# 4. Restarts Polybar, i3

# Theme select
printf "Please select a theme:\n"
select f in ~/.xres/themes/*; do
    test -n "$f" && break;
    echo ">> Invalid Selection";
done

basename=$(basename $f)
echo "Using ${basename} theme..."

# Custom script in ~/bin
echo ">> Generating XFCE Terminal colors..."
~/bin/xfce-terminal-colorize "$f"

# Fix the theme
echo ">> Setting theme in Xresources..."
sed -i -E "s|themes/([a-z_-]+)|themes/${basename}|" .Xresources

# Reload Xresources
echo ">> Reloading Xresources..."
xrdb -load ~/.Xresources

# Restart i3
echo ">> Restarting i3..."
sleep 1
i3-msg restart

# Restart Polybar
echo ">> Restarting Polybar..."
sleep 1
~/.config/polybar/launch

# Reconfigure Dunst from template
echo ">> Reconfiguring Dunst"
background=$(xrdb -query | grep "^*background" -m 1 | cut -f 2)
foreground=$(xrdb -query | grep "^*foreground" -m 1 | cut -f 2)
color1=$(xrdb -query | grep "^*color1" -m 1 | cut -f 2)
cat ~/.templates/dunstrc | awk -v bkg="__BACKGROUND__" -v bkgrep="$background" -v fg="__FOREGROUND__" -v fgrep="$foreground" -v c1="__COLOR1__" -v c1rep="$color1" '{gsub(bkg,bkgrep,$0); gsub(fg,fgrep,$0); gsub(c1,c1rep,$0); print $0}' > ~/.config/dunstrc

# Restart Dunst
echo ">> Restarting Dunst"
killall -q dunst && dunst -conf ~/.config/dunstrc &

